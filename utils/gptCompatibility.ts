export async function fetchCompatibilityResult(people: {
    name: string;
    birth: string;
    time: string;
    place: string;
    gender: string;
    relation: string[];
  }[]) {
    const relationType = people[0]?.relation[0] || 'ê´€ê³„ ë¯¸ì§€ì •'

    let prompt = `
ë‹¹ì‹ ì€ ì‚¬ì£¼ ê¶í•© í’€ì´ ì² í•™ê´€ì˜ ì£¼ì¸ìž…ë‹ˆë‹¤. ë‹¹ì‹ ì˜ ë§íˆ¬ëŠ” ëƒ‰ì •í•˜ê³  ë‚ ì¹´ë¡­ìŠµë‹ˆë‹¤. ì•„ë¬´ë¦¬ ì•„í”ˆ ë§ì´ë¼ë„ ì‚¬ì‹¤ì´ë©´ ê·¸ëŒ€ë¡œ ë§í•´ì¤ë‹ˆë‹¤. ì‚¬íƒ•ë°œë¦¼ì€ ê¸ˆì§€ìž…ë‹ˆë‹¤. ë“£ëŠ” ì‚¬ëžŒì´ ì •ì‹ ì´ ë²ˆì© ë“¤ ìˆ˜ ìžˆë„ë¡ ì§ì„¤ì ì´ê³  ì‹¤ìš©ì ìœ¼ë¡œ í•´ì„í•´ ì£¼ì„¸ìš”.

ì•„ëž˜ëŠ” ë‘ ì‚¬ëžŒì˜ ì‚¬ì£¼ ë° ê´€ê³„ ì •ë³´ìž…ë‹ˆë‹¤:

${people.map((p, i) =>
  `ì‚¬ëžŒ ${i + 1} (${p.name}ë‹˜): ì„±ë³„ ${p.gender}, ìƒë…„ì›”ì¼ ${p.birth}, ì¶œìƒì‹œê°„ ${p.time}, ì¶œìƒì§€ ${p.place}, ê´€ê³„ ìœ í˜•: ${p.relation.join(', ') || 'ì •ë³´ ì—†ìŒ'}`
).join('\n')}

ì´ ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ, íŠ¹ížˆ ì„±ë³„ê³¼ ê´€ê³„ ìœ í˜•(${relationType})ì— ë”°ë¥¸ í•´ì„ ì°¨ì´ë¥¼ ê³ ë ¤í•´ ì‚¬ì£¼í•™ì ìœ¼ë¡œ ê¶í•©ì„ ë¶„ì„í•´ ì£¼ì„¸ìš”.
ì˜¤í–‰, ì‹­ì„±, ì§€ì§€, ì²œê°„ ë“± ì‚¬ì£¼í•™ì  ê´€ì ì„ í† ëŒ€ë¡œ í˜„ì‹¤ê° ìžˆê²Œ ì„¤ëª…í•˜ë˜, ì–´ë ¤ìš´ ìš©ì–´ëŠ” ì“°ì§€ ë§ê³  ì‰½ê²Œ í’€ì–´ ì£¼ì„¸ìš”.

ì‚¬ëžŒë“¤ì´ ì‹¤ì œë¡œ ê¶ê¸ˆí•´í•  ë§Œí•œ ì§ˆë¬¸ì— ëŒ€í•´ ëŒ€ë‹µí•˜ë“¯ í˜„ì‹¤ì ì´ê³  ì‹¤ìš©ì ì¸ í•´ì„ì„ í•´ ì£¼ì„¸ìš”.
`

    let titles: string[] = []

    if (relationType === 'ì—°ì¸') {
      prompt += `
ì•„ëž˜ ì—¬ì„¯ ê°€ì§€ í•­ëª©ì— ëŒ€í•´ ë°˜ë“œì‹œ 'ì œëª©: ë‚´ìš©' í˜•íƒœë¡œ ì¶œë ¥í•´ ì£¼ì„¸ìš”. ê° í•­ëª©ì˜ ì œëª©ì€ ë°˜ë“œì‹œ í•œ ì¤„ë¡œ ëª…í™•ížˆ ì‹œìž‘í•˜ê³ , ë‚´ìš©ì€ ë‹¨ìˆœ ìš”ì•½ì´ ì•„ë‹Œ ì¶©ë¶„í•œ ê¸¸ì´ì™€ ë°€ë„ë¡œ ì •ì„±ìŠ¤ëŸ½ê²Œ ë¶„ì„í•´ ì£¼ì„¸ìš”.

1. ê¸°ë³¸ ì„±í–¥ ê¶í•©: ë‘ ì‚¬ëžŒì˜ ì„±ê²©ì´ ì–´ë–»ê²Œ ì–´ìš¸ë¦¬ëŠ”ì§€ ë¶„ì„í•´ ì£¼ì„¸ìš”.
2. ê°ì • í‘œí˜„ ë°©ì‹: ì„œë¡œì˜ ê°ì • ìŠ¤íƒ€ì¼ì´ ì–´ë–»ê²Œ ë‹¤ë¥´ê³  ì–´ë–¤ ì ì´ ë§žëŠ”ì§€ ì„¤ëª…í•´ ì£¼ì„¸ìš”.
3. ì—°ì•  ìŠ¤íƒ€ì¼ê³¼ ì£¼ë„ê¶Œ: ê´€ê³„ì—ì„œ ëˆ„ê°€ ê°ì •ì ìœ¼ë¡œ ì£¼ë„í•˜ëŠ”ì§€, ì—°ì•  ë°©ì‹ì€ ì–´ë–»ê²Œ ë‹¤ë¥¸ì§€ ë¹„êµí•´ ì£¼ì„¸ìš”.
4. ìž¥ê¸°ì  ê´€ê³„ ìœ ì§€ ê°€ëŠ¥ì„±: ì˜¤ëž˜ ë§Œë‚¬ì„ ë•Œ ê²ªì„ ìˆ˜ ìžˆëŠ” ê°ˆë“±, ë°˜ë³µë˜ëŠ” íŒ¨í„´ì´ ìžˆë‹¤ë©´ ì•Œë ¤ì£¼ì„¸ìš”.
5. ê²°í˜¼ ìš´ê³¼ í˜„ì‹¤ì„±: ê²°í˜¼í–ˆì„ ë•Œ ê²½ì œì /ì •ì„œì ìœ¼ë¡œ ì–´ë–¤ êµ¬ì¡°ê°€ ë ì§€, ìœ„í—˜ ìš”ì†Œê°€ ìžˆë‹¤ë©´ ì†”ì§ížˆ ì§€ì í•´ ì£¼ì„¸ìš”.
6. í˜„ì‹¤ì ì¸ ì´í‰ê³¼ ì¡°ì–¸: ë‘˜ì˜ ê´€ê³„ë¥¼ ìœ ì§€í•˜ê±°ë‚˜ ë§ˆë¬´ë¦¬í•  ë•Œ ì–´ë–¤ íƒœë„ê°€ í•„ìš”í•œì§€ ì§ì„¤ì ìœ¼ë¡œ ì¡°ì–¸í•´ ì£¼ì„¸ìš”.

ê° í•­ëª©ì€ ë°˜ë“œì‹œ ì•„ëž˜ í˜•ì‹ì„ ì§€ì¼œì„œ ì¶œë ¥í•´ ì£¼ì„¸ìš”:

[ì œëª©]
ë‚´ìš©ì€ ë°˜ë“œì‹œ ë‹¤ìŒ ì¤„ë¶€í„° ì‹œìž‘í•˜ë©°, ì œëª©ì€ ë‚´ìš© ì•ˆì— ì ˆëŒ€ ë°˜ë³µí•˜ì§€ ë§ˆì„¸ìš”.
`
      titles = ['ê¸°ë³¸ ì„±í–¥ ê¶í•©', 'ê°ì • í‘œí˜„ ë°©ì‹', 'ì—°ì•  ìŠ¤íƒ€ì¼ê³¼ ì£¼ë„ê¶Œ', 'ìž¥ê¸°ì  ê´€ê³„ ìœ ì§€ ê°€ëŠ¥ì„±', 'ê²°í˜¼ ìš´ê³¼ í˜„ì‹¤ì„±', 'í˜„ì‹¤ì ì¸ ì´í‰ê³¼ ì¡°ì–¸']
    } else if (relationType === 'ì¹œêµ¬') {
      prompt += `
ì•„ëž˜ í•­ëª©ì— ëŒ€í•´ ê°ê° ì œëª©ê³¼ í•¨ê»˜ ì‹¤ìš©ì ìœ¼ë¡œ ë¶„ì„í•´ ì£¼ì„¸ìš”.

1. ì„±ê²© ì¡°í•©ê³¼ ëŒ€í™” ì½”ë“œ: ë‘˜ì€ ì„œë¡œ ëŒ€í™”ê°€ í†µí•˜ëŠ” ì„±í–¥ì¸ì§€, ë§ì´ ìž˜ í†µí•˜ëŠ”ì§€
2. ê°ˆë“± ìœ í˜•: ì¹œêµ¬ ê´€ê³„ì—ì„œ ìžì£¼ ë°œìƒí•  ìˆ˜ ìžˆëŠ” ê°ˆë“±ê³¼ ê°ì • ê¸°ë³µ
3. ìš°ì •ì˜ ì§€ì† ê°€ëŠ¥ì„±: ë©€ì–´ì§€ê±°ë‚˜ ìžì£¼ ì‹¸ìš°ëŠ” ì´ìœ ê°€ ìžˆë‹¤ë©´ ì§šì–´ ì£¼ì„¸ìš”
4. í•¨ê»˜ ìžˆì„ ë•Œ ì„œë¡œì—ê²Œ ì£¼ëŠ” ì˜í–¥: ê¸ì •ì /ë¶€ì •ì  ì—ë„ˆì§€, ìžê·¹ ë˜ëŠ” ë°©í•´ ìš”ì†Œ
5. ì‚¶ì˜ ë°©í–¥ì„±ê³¼ ê¶í•©: ì¸ìƒê´€ì´ë‚˜ ì„±í–¥ ì°¨ì´ê°€ í´ ê²½ìš° ì¡°ì‹¬í•´ì•¼ í•  ì 
6. í•œ ë§ˆë”” ì¡°ì–¸: ì¹œêµ¬ ê´€ê³„ë¡œì„œ ì–´ë–»ê²Œ ìœ ì§€í•˜ë©´ ì¢‹ì€ì§€ í•µì‹¬ë§Œ ì§šì–´ ì£¼ì„¸ìš”

ê° í•­ëª©ì€ ë°˜ë“œì‹œ ì•„ëž˜ í˜•ì‹ì„ ì§€ì¼œì„œ ì¶œë ¥í•´ ì£¼ì„¸ìš”:

[ì œëª©]
ë‚´ìš©ì€ ë°˜ë“œì‹œ ë‹¤ìŒ ì¤„ë¶€í„° ì‹œìž‘í•˜ë©°, ì œëª©ì€ ë‚´ìš© ì•ˆì— ì ˆëŒ€ ë°˜ë³µí•˜ì§€ ë§ˆì„¸ìš”.
`
      titles = ['ì„±ê²© ì¡°í•©ê³¼ ëŒ€í™” ì½”ë“œ', 'ê°ˆë“± ìœ í˜•', 'ìš°ì •ì˜ ì§€ì†ì„±', 'í•¨ê»˜ ìžˆì„ ë•Œ ì„œë¡œì—ê²Œ ì£¼ëŠ” ì˜í–¥', 'ì‚¶ì˜ ë°©í–¥ì„±ê³¼ ê¶í•©', 'í•œ ë§ˆë”” ì¡°ì–¸']
    } else {
      prompt += `
ì•„ëž˜ í•­ëª©ì— ëŒ€í•´ í˜„ì‹¤ì ì´ê³  ëª…í™•í•˜ê²Œ í•´ì„í•´ ì£¼ì„¸ìš”.

1. ê¸°ë³¸ ì„±í–¥ ê¶í•©
2. ê´€ê³„ ë‚´ ìŠ¤íŠ¸ë ˆìŠ¤ ìš”ì¸
3. ì»¤ë®¤ë‹ˆì¼€ì´ì…˜ ë°©ì‹ì˜ ì°¨ì´
4. ì‹ ë¢°/ì˜ì¡´ì˜ ê· í˜•
5. í•¨ê»˜í•  ë•Œ ê¸°ëŒ€ë˜ëŠ” ì„±ìž¥ì„±
6. ê´€ê³„ ìœ ì§€ì— í•„ìš”í•œ ì¡°ì–¸

ê° í•­ëª©ì€ ë°˜ë“œì‹œ ì•„ëž˜ í˜•ì‹ì„ ì§€ì¼œì„œ ì¶œë ¥í•´ ì£¼ì„¸ìš”:

[ì œëª©]
ë‚´ìš©ì€ ë°˜ë“œì‹œ ë‹¤ìŒ ì¤„ë¶€í„° ì‹œìž‘í•˜ë©°, ì œëª©ì€ ë‚´ìš© ì•ˆì— ì ˆëŒ€ ë°˜ë³µí•˜ì§€ ë§ˆì„¸ìš”.
`
      titles = ['ê¸°ë³¸ ì„±í–¥ ê¶í•©', 'ê´€ê³„ ë‚´ ìŠ¤íŠ¸ë ˆìŠ¤ ìš”ì¸', 'ì»¤ë®¤ë‹ˆì¼€ì´ì…˜ ë°©ì‹ì˜ ì°¨ì´', 'ì‹ ë¢°/ì˜ì¡´ì˜ ê· í˜•', 'í•¨ê»˜í•  ë•Œ ê¸°ëŒ€ë˜ëŠ” ì„±ìž¥ì„±', 'ê´€ê³„ ìœ ì§€ì— í•„ìš”í•œ ì¡°ì–¸']
    }
  
    const res = await fetch('/api/gpt', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ prompt }),
    })

    if (res.status === 429) {
      return 'â— ë„ˆë¬´ ë¹ ë¥´ê²Œ ìš”ì²­í–ˆì–´ìš”. ìž ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.'
    }
  
    const data = await res.json()
  
    console.log('ðŸ“¦ GPT ì‘ë‹µ ì›ë³¸:', JSON.stringify(data, null, 2)) // ðŸ” ë¡œê·¸ ì°ê¸°
  
    const raw = data?.choices?.[0]?.message?.content
  
    if (!raw) {
      console.warn('â— GPT ì‘ë‹µ ì—†ìŒ')
      return [{ title: 'ì—ëŸ¬', content: 'GPT ì‘ë‹µì„ ë°›ì•„ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.' }]
    }
  
    const parsed = raw.match(/\[([^\]]+)\]\s*([\s\S]*?)(?=\n\[|$)/g)

    const cards = parsed?.map((block) => {
      const match = block.match(/\[([^\]]+)\]\s*([\s\S]*)/)
      return {
        title: match?.[1]?.trim() || 'ì œëª© ì—†ìŒ',
        content: match?.[2]?.trim() || 'ë‚´ìš© ì—†ìŒ',
      }
    }) || []

    return cards.map((c, i) => `\n${i + 1}. ${c.title}: ${c.content}`).join('\n\n')
  }